<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coliving Task Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 p-4 md:p-6">
  
  <!-- Config Modal -->
  <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h2 class="text-xl font-bold mb-4">Settings</h2>
      
      <div class="mb-6">
        <h3 class="font-semibold text-gray-700 mb-2">Supabase Database</h3>
        <p class="text-sm text-gray-600 mb-3">Required for the app to work across devices.</p>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Supabase URL</label>
            <input type="text" id="configUrl" placeholder="https://xxxxx.supabase.co" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Supabase Publishable Key</label>
            <input type="text" id="configKey" placeholder="sb_publishable_xxx..." 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
        </div>
      </div>

      <button onclick="saveConfig()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
        Save & Connect
      </button>
    </div>
  </div>

  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
        <h1 class="text-2xl md:text-3xl font-bold">Coliving Task Tracker</h1>
        <p class="text-indigo-100 mt-1">Organize household tasks with your housemates</p>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-gray-200 overflow-x-auto">
        <button onclick="switchTab('people')" id="tab-people" class="flex items-center gap-2 px-4 md:px-6 py-4 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap tab-active">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
          People
        </button>
        <button onclick="switchTab('trash')" id="tab-trash" class="flex items-center gap-2 px-4 md:px-6 py-4 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          Trash
        </button>
        <button onclick="switchTab('cleaning')" id="tab-cleaning" class="flex items-center gap-2 px-4 md:px-6 py-4 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
          Cleaning
        </button>
        <button onclick="switchTab('birthdays')" id="tab-birthdays" class="flex items-center gap-2 px-4 md:px-6 py-4 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>
          Birthdays
        </button>
        <button onclick="switchTab('vitalnya')" id="tab-vitalnya" class="flex items-center gap-2 px-4 md:px-6 py-4 font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
          Vitalnya
        </button>
      </div>

      <!-- Content -->
      <div id="content" class="p-4 md:p-6">
        <!-- Content loaded dynamically -->
      </div>
    </div>
    
    <!-- Footer with settings -->
    <div class="mt-4 text-center">
      <button onclick="showConfig()" class="text-sm text-gray-400 hover:text-gray-600">⚙️ Settings</button>
    </div>
  </div>

  <script>
    // ============ SUPABASE SETUP ============
    let supabaseClient = null;
    
    function getConfig() {
      const url = localStorage.getItem('supabase_url');
      const key = localStorage.getItem('supabase_key');
      return { url, key };
    }
    
    function saveConfig() {
      const url = document.getElementById('configUrl').value.trim();
      const key = document.getElementById('configKey').value.trim();
      
      if (url && key) {
        localStorage.setItem('supabase_url', url);
        localStorage.setItem('supabase_key', key);
        location.reload();
      }
    }
    
    function showConfig() {
      const { url, key } = getConfig();
      document.getElementById('configUrl').value = url || '';
      document.getElementById('configKey').value = key || '';
      document.getElementById('configModal').classList.remove('hidden');
    }
    
    function initSupabase() {
      const { url, key } = getConfig();
      if (!url || !key) {
        document.getElementById('configModal').classList.remove('hidden');
        return false;
      }
      supabaseClient = window.supabase.createClient(url, key);
      return true;
    }

    // ============ STATE ============
    let state = {
      people: [],
      trashQueue: [],
      trashCompletion: null,
      cleaningGroups: [],
      cleaningSettings: { start_date: null, start_group_id: null },
      cleaningPostponements: [],
      birthdays: [],
      vitalnyaBookings: [],
      currentTab: 'people',
      currentMonth: new Date()
    };

    // ============ DATABASE FUNCTIONS ============
    async function loadAllData() {
      try {
        const [people, trash, completion, groups, settings, postponements, birthdays, bookings] = await Promise.all([
          supabaseClient.from('people').select('*').order('id'),
          supabaseClient.from('trash_queue').select('*').order('position'),
          supabaseClient.from('trash_completions').select('*').order('completed_date', { ascending: false }).limit(1),
          supabaseClient.from('cleaning_groups').select('*, cleaning_group_members(person_id)'),
          supabaseClient.from('cleaning_settings').select('*').eq('id', 1).single(),
          supabaseClient.from('cleaning_postponements').select('*'),
          supabaseClient.from('birthdays').select('*'),
          supabaseClient.from('vitalnya_bookings').select('*').order('booking_date')
        ]);

        state.people = people.data || [];
        state.trashQueue = trash.data || [];
        state.trashCompletion = completion.data?.[0] || null;
        state.cleaningGroups = (groups.data || []).map(g => ({
          ...g,
          members: g.cleaning_group_members.map(m => m.person_id)
        }));
        state.cleaningSettings = settings.data || { start_date: null, start_group_id: null };
        state.cleaningPostponements = postponements.data || [];
        state.birthdays = birthdays.data || [];
        state.vitalnyaBookings = bookings.data || [];
        
        render();
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    // People functions
    async function addPerson() {
      const input = document.getElementById('newPersonName');
      const name = input.value.trim();
      if (!name) return;
      
      try {
        const { data, error } = await supabaseClient.from('people').insert({ name }).select().single();
        if (error) throw error;
        input.value = '';
        await loadAllData();
      } catch (error) {
        console.error('Error adding person:', error);
        alert('Error adding person: ' + error.message);
      }
    }

    async function removePerson(id) {
      try {
        if (!confirm('Remove this person? They will also be removed from all queues and groups.')) return;
        
        // Delete from all related tables first
        await supabaseClient.from('trash_completions').delete().eq('completed_by', id);
        await supabaseClient.from('trash_queue').delete().eq('person_id', id);
        await supabaseClient.from('birthdays').delete().eq('person_id', id);
        await supabaseClient.from('cleaning_group_members').delete().eq('person_id', id);
        
        const { error } = await supabaseClient.from('people').delete().eq('id', id);
        if (error) throw error;
        
        await loadAllData();
      } catch (error) {
        console.error('Error removing person:', error);
        alert('Error removing person: ' + error.message);
      }
    }

    // Trash functions
    async function addToTrashQueue(personId) {
      try {
        const position = state.trashQueue.length;
        const { error } = await supabaseClient.from('trash_queue').insert({ person_id: personId, position });
        if (error) throw error;
        await loadAllData();
      } catch (error) {
        console.error('Error adding to queue:', error);
        alert('Error adding to queue: ' + error.message);
      }
    }

    async function insertIntoTrashQueue(personId, afterIndex) {
      try {
        // Clear and rebuild the queue in database
        await supabaseClient.from('trash_queue').delete().neq('id', 0);
        
        const inserts = [
          ...state.trashQueue.slice(0, afterIndex).map((q, i) => ({ person_id: q.person_id, position: i })),
          { person_id: personId, position: afterIndex },
          ...state.trashQueue.slice(afterIndex).map((q, i) => ({ person_id: q.person_id, position: afterIndex + 1 + i }))
        ];
        
        const { error } = await supabaseClient.from('trash_queue').insert(inserts);
        if (error) throw error;
        await loadAllData();
      } catch (error) {
        console.error('Error inserting into queue:', error);
        alert('Error inserting into queue: ' + error.message);
      }
    }

    async function removeFromTrashQueue(id) {
      try {
        const { error } = await supabaseClient.from('trash_queue').delete().eq('id', id);
        if (error) throw error;
        
        // Reorder remaining items
        const remaining = state.trashQueue.filter(t => t.id !== id);
        for (let i = 0; i < remaining.length; i++) {
          await supabaseClient.from('trash_queue').update({ position: i }).eq('id', remaining[i].id);
        }
        
        await loadAllData();
      } catch (error) {
        console.error('Error removing from queue:', error);
        alert('Error removing from queue: ' + error.message);
      }
    }

    async function markTrashDone() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const currentPerson = state.trashQueue[0]?.person_id;
        
        if (!currentPerson) return;
        
        // Save who completed it today
        const { error: completionError } = await supabaseClient.from('trash_completions').upsert({ 
          completed_date: today, 
          completed_by: currentPerson 
        }, { onConflict: 'completed_date' });
        if (completionError) throw completionError;
        
        // Rotate the queue: move first person to the end
        if (state.trashQueue.length > 1) {
          const [first, ...rest] = state.trashQueue;
          const newQueue = [...rest, first];
          
          // Update positions in database
          for (let i = 0; i < newQueue.length; i++) {
            await supabaseClient.from('trash_queue').update({ position: i }).eq('id', newQueue[i].id);
          }
        }
        
        await loadAllData();
      } catch (error) {
        console.error('Error marking trash done:', error);
        alert('Error marking trash done: ' + error.message);
      }
    }

    function isTrashCompletedToday() {
      if (!state.trashCompletion) return false;
      const today = new Date().toISOString().split('T')[0];
      return state.trashCompletion.completed_date === today;
    }

    async function unmarkTrashDone() {
      try {
        // Move the last person (who just completed) back to the front
        if (state.trashQueue.length > 1) {
          const last = state.trashQueue.pop();
          state.trashQueue.unshift(last);
          
          // Update positions in database
          for (let i = 0; i < state.trashQueue.length; i++) {
            await supabaseClient.from('trash_queue').update({ position: i }).eq('id', state.trashQueue[i].id);
          }
        }
        
        // Delete today's completion
        const today = new Date().toISOString().split('T')[0];
        const { error } = await supabaseClient.from('trash_completions').delete().eq('completed_date', today);
        if (error) throw error;
        
        await loadAllData();
      } catch (error) {
        console.error('Error unmarking trash:', error);
        alert('Error unmarking trash: ' + error.message);
      }
    }

    async function rotateTrashQueueIfNeeded() {
      // Clear yesterday's completion status on new day
      if (state.trashCompletion) {
        const today = new Date().toISOString().split('T')[0];
        if (state.trashCompletion.completed_date < today) {
          state.trashCompletion = null;
        }
      }
    }

    // Cleaning groups functions
    async function createCleaningGroup() {
      try {
        const nameInput = document.getElementById('newGroupName');
        const name = nameInput.value.trim();
        const checkboxes = document.querySelectorAll('.group-member-checkbox:checked');
        const memberIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (!name || memberIds.length === 0) return;
        
        const { data: group, error } = await supabaseClient.from('cleaning_groups').insert({ name }).select().single();
        if (error) throw error;
        
        const memberInserts = memberIds.map(person_id => ({ group_id: group.id, person_id }));
        const { error: memberError } = await supabaseClient.from('cleaning_group_members').insert(memberInserts);
        if (memberError) throw memberError;
        
        nameInput.value = '';
        await loadAllData();
      } catch (error) {
        console.error('Error creating group:', error);
        alert('Error creating group: ' + error.message);
      }
    }

    async function removeCleaningGroup(id) {
      try {
        if (!confirm('Remove this cleaning group?')) return;
        
        // Delete members first
        await supabaseClient.from('cleaning_group_members').delete().eq('group_id', id);
        
        const { error } = await supabaseClient.from('cleaning_groups').delete().eq('id', id);
        if (error) throw error;
        
        // Clear schedule if this group was the start group
        if (state.cleaningSettings.start_group_id === id) {
          await supabaseClient.from('cleaning_settings').update({ start_date: null, start_group_id: null }).eq('id', 1);
        }
        
        await loadAllData();
      } catch (error) {
        console.error('Error removing group:', error);
        alert('Error removing group: ' + error.message);
      }
    }

    async function saveCleaningSettings() {
      try {
        const startDate = document.getElementById('cleaningStartDate').value;
        const startGroupId = parseInt(document.getElementById('cleaningStartGroup').value) || null;
        
        const { error } = await supabaseClient.from('cleaning_settings').update({ 
          start_date: startDate || null, 
          start_group_id: startGroupId 
        }).eq('id', 1);
        if (error) throw error;
        
        await loadAllData();
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('Error saving settings: ' + error.message);
      }
    }

    async function postponeCleaning(originalDate, newDate, groupId, groupName) {
      try {
        const { error } = await supabaseClient.from('cleaning_postponements').insert({
          original_date: originalDate,
          new_date: newDate,
          group_id: groupId,
          group_name: groupName
        });
        if (error) throw error;
        
        await loadAllData();
      } catch (error) {
        console.error('Error postponing:', error);
        alert('Error postponing: ' + error.message);
      }
    }

    async function cancelPostponement(id) {
      try {
        const { error } = await supabaseClient.from('cleaning_postponements').delete().eq('id', id);
        if (error) throw error;
        
        await loadAllData();
      } catch (error) {
        console.error('Error canceling postponement:', error);
        alert('Error canceling postponement: ' + error.message);
      }
    }

    // Birthday functions
    async function setBirthday(personId, date) {
      try {
        if (!date) {
          const { error } = await supabaseClient.from('birthdays').delete().eq('person_id', personId);
          if (error) throw error;
        } else {
          const existing = state.birthdays.find(b => b.person_id === personId);
          if (existing) {
            const { error } = await supabaseClient.from('birthdays').update({ birth_date: date }).eq('person_id', personId);
            if (error) throw error;
          } else {
            const { error } = await supabaseClient.from('birthdays').insert({ person_id: personId, birth_date: date });
            if (error) throw error;
          }
        }
        await loadAllData();
      } catch (error) {
        console.error('Error setting birthday:', error);
        alert('Error setting birthday: ' + error.message);
      }
    }

    // Vitalnya functions
    async function addVitalnyaBooking() {
      try {
        const date = document.getElementById('vitalnyaDate').value;
        const timeStart = document.getElementById('vitalnyaTimeStart').value;
        const timeEnd = document.getElementById('vitalnyaTimeEnd').value;
        const name = document.getElementById('vitalnyaName').value.trim();
        const strict = document.getElementById('vitalnyaStrict').checked;
        
        if (!date || !timeStart || !timeEnd || !name) return;
        
        const { error } = await supabaseClient.from('vitalnya_bookings').insert({
          booking_date: date,
          time_start: timeStart,
          time_end: timeEnd,
          name,
          strict
        });
        if (error) throw error;
        
        document.getElementById('vitalnyaDate').value = '';
        document.getElementById('vitalnyaTimeStart').value = '';
        document.getElementById('vitalnyaTimeEnd').value = '';
        document.getElementById('vitalnyaName').value = '';
        document.getElementById('vitalnyaStrict').checked = false;
        
        await loadAllData();
      } catch (error) {
        console.error('Error adding booking:', error);
        alert('Error adding booking: ' + error.message);
      }
    }

    async function removeVitalnyaBooking(id) {
      try {
        const { error } = await supabaseClient.from('vitalnya_bookings').delete().eq('id', id);
        if (error) throw error;
        
        await loadAllData();
      } catch (error) {
        console.error('Error removing booking:', error);
        alert('Error removing booking: ' + error.message);
      }
    }

    // ============ HELPER FUNCTIONS ============
    function getPersonName(id) {
      return state.people.find(p => p.id === id)?.name || 'Unknown';
    }

    function toLocalDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function getGroupForDate(date) {
      const { start_date, start_group_id } = state.cleaningSettings;
      if (!start_date || !start_group_id || state.cleaningGroups.length === 0) return null;
      
      const startDate = new Date(start_date + 'T00:00:00');
      const checkDate = new Date(date);
      checkDate.setHours(0, 0, 0, 0);
      
      const daysDiff = Math.floor((checkDate - startDate) / (1000 * 60 * 60 * 24));
      if (daysDiff < 0 || daysDiff % 4 !== 0) return null;
      
      const cyclePosition = Math.floor(daysDiff / 4);
      const startGroupIndex = state.cleaningGroups.findIndex(g => g.id === start_group_id);
      if (startGroupIndex === -1) return null;
      
      const rotationOrder = [...state.cleaningGroups.slice(startGroupIndex), ...state.cleaningGroups.slice(0, startGroupIndex)];
      return rotationOrder[cyclePosition % rotationOrder.length];
    }

    function getDisplayInfoForDate(date) {
      const dateKey = toLocalDateKey(date);
      const originalGroup = getGroupForDate(date);
      
      const postponement = state.cleaningPostponements.find(p => p.original_date === dateKey);
      if (postponement) {
        return { type: 'postponed-from', originalGroup, newDate: postponement.new_date, dateKey, postponementId: postponement.id };
      }
      
      const postponedTo = state.cleaningPostponements.find(p => p.new_date === dateKey);
      if (postponedTo) {
        const group = state.cleaningGroups.find(g => g.id === postponedTo.group_id);
        return { type: 'postponed-to', group: group || { name: postponedTo.group_name }, originalDate: postponedTo.original_date, dateKey };
      }
      
      if (originalGroup) {
        return { type: 'scheduled', group: originalGroup, dateKey };
      }
      
      return null;
    }

    function getUpcomingBirthdays() {
      const today = new Date();
      return state.birthdays.map(b => {
        const [year, month, day] = b.birth_date.split('-').map(Number);
        const bday = new Date(today.getFullYear(), month - 1, day);
        if (bday < today) bday.setFullYear(today.getFullYear() + 1);
        const daysUntil = Math.ceil((bday - today) / (1000 * 60 * 60 * 24));
        return { ...b, name: getPersonName(b.person_id), daysUntil };
      }).filter(b => b.daysUntil <= 30).sort((a, b) => a.daysUntil - b.daysUntil);
    }

    // ============ TAB SWITCHING ============
    function switchTab(tab) {
      state.currentTab = tab;
      document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.remove('tab-active'));
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      render();
    }

    // ============ RENDER FUNCTIONS ============
    function render() {
      const content = document.getElementById('content');
      switch (state.currentTab) {
        case 'people': content.innerHTML = renderPeople(); break;
        case 'trash': content.innerHTML = renderTrash(); break;
        case 'cleaning': content.innerHTML = renderCleaning(); break;
        case 'birthdays': content.innerHTML = renderBirthdays(); break;
        case 'vitalnya': content.innerHTML = renderVitalnya(); break;
      }
    }

    function renderPeople() {
      return `
        <div class="mb-6">
          <div class="flex gap-2">
            <input type="text" id="newPersonName" placeholder="Enter person's name" 
                   onkeypress="if(event.key==='Enter')addPerson()"
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="addPerson()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              Add
            </button>
          </div>
        </div>
        ${state.people.length === 0 ? `
          <div class="text-center py-12 text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            <p>No people added yet. Add your first housemate!</p>
          </div>
        ` : `
          <div class="space-y-2">
            ${state.people.map(person => `
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
                <span class="font-medium text-gray-800">${person.name}</span>
                <button onclick="removePerson(${person.id})" class="text-red-500 hover:text-red-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    function renderTrash() {
      const isCompleted = isTrashCompletedToday();
      const currentPerson = isCompleted 
        ? getPersonName(state.trashCompletion.completed_by)
        : (state.trashQueue[0] ? getPersonName(state.trashQueue[0].person_id) : null);
      
      return `
        <div class="mb-6 p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200">
          ${currentPerson ? `
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h3 class="font-bold text-sm text-gray-600 mb-1">Today's Turn:</h3>
                <p class="text-3xl font-bold text-green-700">${currentPerson}</p>
              </div>
              ${isCompleted ? `
                <button onclick="unmarkTrashDone()" class="px-6 py-3 bg-green-100 text-green-800 rounded-lg font-medium hover:bg-green-200 transition-colors">✓ Completed (click to undo)</button>
              ` : `
                <button onclick="markTrashDone()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                  Mark as Done
                </button>
              `}
            </div>
          ` : `
            <p class="text-gray-500">No one in queue yet. Add people to the queue below.</p>
          `}
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-bold text-lg mb-3 text-gray-800">Queue Order</h3>
            ${state.trashQueue.length === 0 ? `
              <div class="text-center py-8 bg-gray-50 rounded-lg text-gray-400">
                <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <p>Queue is empty</p>
              </div>
            ` : `
              <div class="space-y-1">
                ${renderInsertButton(0)}
                ${state.trashQueue.map((item, index) => `
                  <div class="flex items-center gap-3 p-3 rounded-lg ${index === 0 ? 'bg-green-100 border-2 border-green-300' : 'bg-gray-50'}">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${index === 0 ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-600'}">
                      ${index + 1}
                    </span>
                    <span class="flex-1 font-medium ${index === 0 ? 'text-green-800' : 'text-gray-700'}">
                      ${getPersonName(item.person_id)}
                    </span>
                    <button onclick="removeFromTrashQueue(${item.id})" class="text-red-400 hover:text-red-600 p-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                  </div>
                  ${renderInsertButton(index + 1)}
                `).join('')}
              </div>
            `}
          </div>

          <div>
            <h3 class="font-bold text-lg mb-3 text-gray-800">Add to End of Queue</h3>
            ${state.people.length === 0 ? `
              <div class="text-center py-8 bg-gray-50 rounded-lg text-gray-400">
                <p>Add people in the People tab first</p>
              </div>
            ` : `
              <div class="space-y-2">
                ${state.people.map(person => {
                  const count = state.trashQueue.filter(t => t.person_id === person.id).length;
                  return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-gray-800">${person.name}</span>
                        ${count > 0 ? `<span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full">×${count} in queue</span>` : ''}
                      </div>
                      <button onclick="addToTrashQueue(${person.id})" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Add
                      </button>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderInsertButton(position) {
      if (state.people.length === 0) return '';
      return `
        <div class="insert-btn-container py-1" data-position="${position}">
          <button onclick="toggleInsertMenu(${position})" class="w-full flex items-center justify-center gap-1 py-1 text-xs text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors">
            <div class="flex-1 h-px bg-gray-200"></div>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            <span>Insert</span>
            <div class="flex-1 h-px bg-gray-200"></div>
          </button>
          <div id="insert-menu-${position}" class="hidden bg-indigo-50 border-2 border-indigo-200 rounded-lg p-2 mt-1">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium text-indigo-700">Select person:</span>
              <button onclick="toggleInsertMenu(${position})" class="text-gray-400 hover:text-gray-600 text-xs">Cancel</button>
            </div>
            <div class="flex flex-wrap gap-1">
              ${state.people.map(p => `
                <button onclick="insertIntoTrashQueue(${p.id}, ${position})" class="px-2 py-1 bg-white text-indigo-700 rounded text-sm hover:bg-indigo-600 hover:text-white border border-indigo-200">
                  ${p.name}
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function toggleInsertMenu(position) {
      const menu = document.getElementById(`insert-menu-${position}`);
      menu.classList.toggle('hidden');
    }

    function renderCleaning() {
      const { start_date, start_group_id } = state.cleaningSettings;
      const hasSchedule = start_date && start_group_id;
      
      return `
        ${state.cleaningGroups.length > 0 ? `
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-lg text-gray-800">Cleaning Schedule</h3>
              <button onclick="document.getElementById('scheduleSetup').classList.toggle('hidden')" 
                      class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                ${hasSchedule ? 'Change Schedule' : 'Set Schedule'}
              </button>
            </div>

            <div id="scheduleSetup" class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg ${hasSchedule ? 'hidden' : ''}">
              <h4 class="font-bold text-gray-800 mb-3">Set Starting Point</h4>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm text-gray-600 mb-1">First cleaning date:</label>
                  <input type="date" id="cleaningStartDate" value="${start_date || ''}" 
                         class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">First group to clean:</label>
                  <select id="cleaningStartGroup" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Select a group</option>
                    ${state.cleaningGroups.map(g => `<option value="${g.id}" ${g.id === start_group_id ? 'selected' : ''}>${g.name}</option>`).join('')}
                  </select>
                </div>
                <button onclick="saveCleaningSettings()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                  Save Schedule
                </button>
              </div>
            </div>

            ${hasSchedule ? renderCalendar() : `
              <div class="text-center py-8 bg-gray-50 rounded-lg text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <p>Set a starting date and group to view the schedule</p>
              </div>
            `}
            
            ${state.cleaningPostponements.length > 0 ? `
              <div class="mt-4 p-4 bg-orange-50 border-2 border-orange-200 rounded-lg">
                <h4 class="font-bold text-gray-800 mb-3">Active Postponements</h4>
                <div class="space-y-2">
                  ${state.cleaningPostponements.map(p => `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                      <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">${p.group_name}:</span>
                        <span class="line-through text-gray-400">${formatDate(p.original_date)}</span>
                        <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        <span class="font-medium text-green-700">${formatDate(p.new_date)}</span>
                      </div>
                      <button onclick="cancelPostponement(${p.id})" class="text-red-500 hover:text-red-700 text-sm">Cancel</button>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        ` : ''}

        <h3 class="font-bold text-lg mb-3 text-gray-800">Create Cleaning Group</h3>
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
          <input type="text" id="newGroupName" placeholder="Group name (e.g., Team A)" 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-3">
          <p class="text-sm text-gray-600 mb-2">Select people for this group:</p>
          <div class="space-y-2 mb-4">
            ${state.people.map(p => `
              <label class="flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer">
                <input type="checkbox" value="${p.id}" class="group-member-checkbox w-4 h-4">
                <span class="text-gray-800">${p.name}</span>
              </label>
            `).join('')}
          </div>
          <button onclick="createCleaningGroup()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300">
            Create Group
          </button>
        </div>

        <h3 class="font-bold text-lg mb-3 text-gray-800">Cleaning Groups</h3>
        ${state.cleaningGroups.length === 0 ? `
          <div class="text-center py-8 text-gray-400">
            <p>No cleaning groups yet. Create your first group!</p>
          </div>
        ` : `
          <div class="space-y-3">
            ${state.cleaningGroups.map(group => `
              <div class="p-4 bg-gray-50 rounded-lg">
                <div class="flex items-start justify-between">
                  <div>
                    <h4 class="font-bold text-gray-800">${group.name}</h4>
                    <p class="text-sm text-gray-600">${group.members.map(id => getPersonName(id)).join(', ')}</p>
                  </div>
                  <button onclick="removeCleaningGroup(${group.id})" class="text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    function renderCalendar() {
      const year = state.currentMonth.getFullYear();
      const month = state.currentMonth.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDay = firstDay.getDay();
      const today = new Date();

      let calendarDays = '';
      
      for (let i = 0; i < startingDay; i++) {
        calendarDays += '<div class="p-1 min-h-20"></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const isToday = date.toDateString() === today.toDateString();
        const displayInfo = getDisplayInfoForDate(date);
        const dateKey = toLocalDateKey(date);
        
        let bgColor = '';
        let borderColor = 'border-gray-200';
        let content = '';
        let clickHandler = '';
        
        if (isToday) {
          bgColor = 'bg-blue-100';
          borderColor = 'border-blue-400';
        }
        
        if (displayInfo) {
          if (displayInfo.type === 'scheduled') {
            bgColor = isToday ? 'bg-blue-100' : 'bg-purple-50';
            content = `<div class="text-xs mt-1 font-medium text-purple-700 truncate">${displayInfo.group.name}</div>`;
            clickHandler = `onclick="showPostponeModal('${dateKey}', ${displayInfo.group.id}, '${displayInfo.group.name}')"`;
          } else if (displayInfo.type === 'postponed-from') {
            bgColor = isToday ? 'bg-blue-100' : 'bg-orange-50';
            borderColor = 'border-orange-300';
            content = `
              <div class="text-xs mt-1">
                <span class="line-through text-orange-600 block truncate">${displayInfo.originalGroup?.name || ''}</span>
                <span class="text-orange-500 flex items-center gap-0.5">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                  ${formatDate(displayInfo.newDate).split(',')[0]}
                </span>
              </div>
            `;
          } else if (displayInfo.type === 'postponed-to') {
            bgColor = isToday ? 'bg-blue-100' : 'bg-green-50';
            borderColor = 'border-green-400';
            content = `
              <div class="text-xs mt-1">
                <span class="font-medium text-green-700 block truncate">${displayInfo.group.name}</span>
                <span class="text-green-600">(moved)</span>
              </div>
            `;
          }
        }
        
        calendarDays += `
          <div class="p-1 min-h-20 border rounded ${bgColor} ${borderColor} ${displayInfo?.type === 'scheduled' ? 'cursor-pointer hover:bg-purple-100' : ''}" ${clickHandler}>
            <div class="text-sm font-medium ${isToday ? 'text-blue-700' : 'text-gray-700'}">${day}</div>
            ${content}
          </div>
        `;
      }

      return `
        <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
          <div class="flex items-center justify-between mb-4">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <h4 class="font-bold text-lg">${state.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h4>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
          </div>
          <p class="text-xs text-gray-500 mb-3 text-center">Click on a scheduled cleaning to postpone it</p>
          <div class="grid grid-cols-7 gap-1">
            ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div class="text-center font-bold text-sm text-gray-600 p-2">${d}</div>`).join('')}
            ${calendarDays}
          </div>
        </div>
        
        <div id="postponeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="font-bold text-lg mb-4 text-gray-800">Postpone Cleaning</h3>
            <div id="postponeModalContent"></div>
          </div>
        </div>
      `;
    }

    function changeMonth(delta) {
      state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + delta, 1);
      render();
    }

    function showPostponeModal(dateKey, groupId, groupName) {
      const [year, month, day] = dateKey.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      
      document.getElementById('postponeModal').classList.remove('hidden');
      document.getElementById('postponeModalContent').innerHTML = `
        <div class="mb-4 p-3 bg-purple-50 rounded-lg">
          <p class="text-sm text-gray-600">Group:</p>
          <p class="font-bold text-purple-700">${groupName}</p>
          <p class="text-sm text-gray-600 mt-2">Originally scheduled:</p>
          <p class="font-medium text-gray-800">${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-gray-600 mb-2">Move to new date:</label>
          <input type="date" id="postponeNewDate" min="${new Date().toISOString().split('T')[0]}"
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="flex gap-3">
          <button onclick="hidePostponeModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
            Cancel
          </button>
          <button onclick="confirmPostpone('${dateKey}', ${groupId}, '${groupName}')" 
                  class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
            Postpone
          </button>
        </div>
      `;
    }

    function hidePostponeModal() {
      document.getElementById('postponeModal').classList.add('hidden');
    }

    function confirmPostpone(originalDate, groupId, groupName) {
      const newDate = document.getElementById('postponeNewDate').value;
      if (newDate) {
        postponeCleaning(originalDate, newDate, groupId, groupName);
        hidePostponeModal();
      }
    }

    function renderBirthdays() {
      const upcoming = getUpcomingBirthdays();
      
      return `
        <div class="mb-6">
          <h3 class="font-bold text-lg mb-4 text-gray-800">Upcoming Birthdays</h3>
          ${upcoming.length > 0 ? `
            <div class="space-y-3">
              ${upcoming.map(b => `
                <div class="p-4 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg border-2 border-pink-200">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-bold text-lg text-gray-800">${b.name}</p>
                      <p class="text-sm text-gray-600">${formatDate(b.birth_date)}</p>
                    </div>
                    <div class="text-right">
                      <p class="text-2xl font-bold text-pink-600">${b.daysUntil}</p>
                      <p class="text-xs text-gray-600">days</p>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div class="text-center py-8 text-gray-400">
              <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>
              <p>No upcoming birthdays in the next 30 days</p>
            </div>
          `}
        </div>

        <h3 class="font-bold text-lg mb-3 text-gray-800">Set Birthdays</h3>
        ${state.people.length === 0 ? `
          <div class="text-center py-8 text-gray-400">
            <p>Add people first to set their birthdays</p>
          </div>
        ` : `
          <div class="space-y-3">
            ${state.people.map(person => {
              const bday = state.birthdays.find(b => b.person_id === person.id);
              return `
                <div class="p-4 bg-gray-50 rounded-lg">
                  <div class="flex items-center justify-between gap-4">
                    <span class="font-medium text-gray-800">${person.name}</span>
                    <input type="date" value="${bday?.birth_date || ''}" 
                           onchange="setBirthday(${person.id}, this.value)"
                           class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `}
      `;
    }

    function renderVitalnya() {
      const sortedBookings = [...state.vitalnyaBookings].sort((a, b) => 
        new Date(a.booking_date + 'T' + a.time_start) - new Date(b.booking_date + 'T' + b.time_start)
      );
      
      return `
        <h3 class="font-bold text-lg mb-4 text-gray-800">Book Vitalnya Room</h3>
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Date:</label>
              <input type="date" id="vitalnyaDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-gray-600 mb-1">Start Time:</label>
                <input type="time" id="vitalnyaTimeStart" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">End Time:</label>
                <input type="time" id="vitalnyaTimeEnd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Your Name:</label>
              <input type="text" id="vitalnyaName" placeholder="Enter your name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="vitalnyaStrict" class="w-4 h-4">
                <span class="text-sm text-gray-700">Strictly no entry (do not disturb)</span>
              </label>
            </div>
            <button onclick="addVitalnyaBooking()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
              Book Room
            </button>
          </div>
        </div>

        <h3 class="font-bold text-lg mb-3 text-gray-800">Upcoming Bookings</h3>
        ${sortedBookings.length === 0 ? `
          <div class="text-center py-8 text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
            <p>No bookings yet</p>
          </div>
        ` : `
          <div class="space-y-3">
            ${sortedBookings.map(booking => `
              <div class="p-4 rounded-lg border-2 ${booking.strict ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'}">
                <div class="flex items-start justify-between">
                  <div>
                    <div class="flex items-center gap-2 mb-1">
                      <p class="font-bold text-lg text-gray-800">${booking.name}</p>
                      ${booking.strict ? '<span class="px-2 py-0.5 bg-red-200 text-red-800 text-xs rounded-full font-medium">Do Not Disturb</span>' : ''}
                    </div>
                    <p class="text-sm text-gray-600">${formatDate(booking.booking_date)}</p>
                    <p class="text-sm font-medium text-gray-700 mt-1">${booking.time_start} - ${booking.time_end}</p>
                  </div>
                  <button onclick="removeVitalnyaBooking(${booking.id})" class="text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    // ============ INITIALIZATION ============
    async function init() {
      if (initSupabase()) {
        await loadAllData();
        await rotateTrashQueueIfNeeded();
        render();
      }
    }

    init();
  </script>
</body>
</html>
